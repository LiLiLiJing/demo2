<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>demo</title>
		<meta name="description" content="">
		<meta name="keywords" content="">
		<script src="../static/libs/jquery-1.11.2.min.js" type="text/javascript"></script>
		<style type="text/css">
			* {
            padding: 0;
            margin: 0;
			font: 14px "微软雅黑";
        	}
			body{
				background-color:#eee;
				}
			img{
				border:none;
				width:100px;
				height:100px;
				}
			ul,ol{
				list-style:none;
			}
	        table {
	            border-collapse: collapse;
	            border-spacing: 0;
	            border: 1px solid #c0c0c0;
	            width: 95%;
	            margin-bottom:15px;
				}
	        table:hover{
	            background-color: #fafafa;
	        }
	        table div{
            font-size:14px;
            font-weight:bold;
        	}
	        th,
	        td {
	            border: 1px solid #d0d0d0;
	            color: #404060;
	            padding: 10px;
	        }
	        td{
            
            word-break:break-all;
            
	        }
	        .info{
	        	width: 1300px;
				margin:25px auto;
	        }
	        .contents{
	        	width:1300px;
	        	margin:0 auto;
	        	position:relative;
	        }
	        .fl{
	        	float:left;
	        }
	        .fr{
	        	float:right;
	        }
	        .clearfix:after{
				content:'';
				display:block;
				clear:both;
			}
			.left{
				margin:5px;
				overflow-y:auto;
				width:220px;
			}
			.left ul{
				width:200px;
			}
			.left li{
				background-color:#4876FF;
				margin-bottom:5px;
				height:58px;
				overflow:hidden;
				cursor:pointer;
				border-radius:5px;
				padding-left:8px;
				color:#fff;
			}
			.left li div{
				overflow: hidden;

				white-space: nowrap;

				text-overflow: ellipsis;
			}
			.right{
				width: 1090px;
				padding-left:18px;
				position:absolute;
				top:0px;
				left:220px;
				overflow-y:auto;
				margin:5px;
			}
			.imgBox{

			}
			.right .oneBox{
				width:100px;

				margin:0 5px;
				margin-bottom: 5px;
				cursor:pointer;
            	text-align:center;
				position:relative;
				display:inline-block;
				
			}
			.oneBox span{
				display:block;
				width:100px;
				height:36px;
				word-wrap: break-word;
				overflow:hidden;
			}
			.infoBox{
				background-color: skyblue;
				color:#000;
				border-radius:5px;
				width:980px;
				height:80px;
				margin-top:16px;
				display:none;
				position:absolute;
				top:140px;
				left:0;
				padding-top:12px;
			}
			.shape{
				width: 0;
    			height: 0;
    			border-left: 10px solid transparent;
    			border-right: 10px solid transparent;
    			border-bottom: 15px solid skyblue;
    			position:absolute;
    			top:141px;
				left:40px;
				display:none;
			}
			.selTime{
				width:84px;
			}
			.select{
				margin-left: 10px;
				margin-right: 10px;
			}
			#begin{
				width:90%;
				height:100%;
				text-align:center;
				font-size:60px;
				color:rgba(0, 0, 255, .7);
				font-weight:600;
				margin-top:15px;
				letter-spacing:20px;
			}
			.headleft .userBox{
				float:right;
				color:#000;
				font-size:14px;
				margin-top:28px;
			}
			.empty{
				background-color:#eee!important;
				font-size:18px!important;
				color:#000!important;
			}
			.orderInfo{
				width:900px;
				margin-bottom:20px;
				display:none;
			}
			.header{
				width:100%;
				height:60px;
				background-color:#4c4e5a;
			}
			.headleft{
				width: 1300px;
				height: 60px;
				margin:0 auto;
				

			}
			.headleft .title{
				font-size:25px;
				color:#fff;
				font-weight:bold;
				margin-top:12px;
				margin-left:5px;
				float:left;
			}
			.headleft .rightstyle{
				color:#fff!important;
				font-size:14px;
				margin-bottom:5px;
			}

			.headleft img{
				height:50px;
				width: 50px;
				margin-top:5px;
				float:left;
			}
			.ongoing{
				width:10px;
				height: 10px;
				border-radius:5px;
				background-color:green;
				position:absolute;
				top:4px;
				right:4px;
			}
			.finished{
				width:10px;
				height: 10px;
				border-radius:5px;
				background-color:red;
				position:absolute;
				top:4px;
				right:4px;
			}
			.nodo{
				width:10px;
				height: 10px;
				border-radius:5px;
				background-color:#fff;
				position:absolute;
				top:4px;
				right:4px;
			}
			.infoBox .imginfo{
				float:left;
				margin-left:10px;
			}
			.infoBox .comment{
				float:left;
				position:relative;
				margin-left:10px;
				width:410px;
				height:70px;
			}
			.infoBox{
				text-align:left;
			}
			.infoBox .commentTitle{
				position:absolute;
				top:0px;
				left:0px;
				width:80px;
			}
			.infoBox textarea{
				position:absolute;
				top:18px;
				left:0;
				resize: none;
				outline:none;
				width:400px;
				height:48px;
			}
			.infoBox .paint{
				float:left;
				margin-left:10px;
				padding-top:14px;
			}
			.infoBox .paint .switch{
				width:50px;
				height:25px;
				background-color:green;
				position:relative;
				border-radius:25px;
			}
			.infoBox .paint .ball{
				position:absolute;
				width:25px;
				height:25px;
				border-radius:25px;
				background-color:#fff;
				left:25px;
			}
			.imgstatus{

			}
			.infoBox button{
				box-shadow:0 2px 0 gray;
				width:50px;
				border-radius:15px;
			}
			.infoBox .btn1{
				margin-top:5px;
			}
			.paint2{
				float:left;
				margin-left:60px;
				padding-top:14px;
			}
			.infoBox .gopaint{
				margin-top:10px;
				margin-left:5px;
			}
		</style>
	</head>
	
	<body>
		<div class="header">
			<div class="headleft">
			    <img src="static/images/logo.jpg"/>     
			    <div class="title">Remote Sensing Artificial Intelligence Service 遥感智能服务</div>
			    <div class="userBox">
					<span class="rightstyle"></span>
					<span class="rightstyle">用户名:</span>
					<span class="userName rightstyle">{{store_dict['user_name']}}</span>
					
					<span class="rightstyle">退出登录</span>
				</div>
			</div>
		</div>
		<div class="info">
			<span class="selectUser">
				
				<span class="select">订单筛选:</span>
				<select class="selTime" id="selTime">
					<option value="all" selected="selected">全部</option>
					<option value="3">过去3天</option>
					<option value="7">过去7天</option>
					<option value="30">过去30天</option>
				</select>
			</span>
		</div>
		<div class="contents clearfix">
			
			<div class="left fl">
				<ul>
					
				</ul>
			</div>
			<div class="right fl">
				<div class="orderInfo"></div>
				<div class="clearfix imgBox">
					<div id="begin">欢迎进入</div>
					<div id="begin">遥感智能服务系统</div>
				</div>
				
			</div>
		</div>
		
	</body>
	
	<script type="text/javascript">

		$(".contents").height($(window).height()-100);
		$(".left").height($(window).height()-110);
		$(".right").height($(window).height()-110);
		function imgInfo(info,index){
			var str="";
			var str1="";
			var storenameArr=[];
			var workspaceArr=[];
			var j=0;
			var oneArr;
			for(var i=0;i<info.length;i++){
				var storename=info[i].storename;
				storenameArr.push(storename);
			}
			for(var i=0;i<info.length;i++){
				var spacename=info[i].workspacename;
				workspaceArr.push(spacename);
			}
			for(var a=0;a<workspaceArr.length;a++){				
				$.ajax({
	                url:'http://{{store_dict['remote_addr']}}:{{store_dict['port_number']}}/thumbnail&'+workspaceArr[a],
	                type:'get',
	                dataType:'JSON',
	                success:function(data){
	                	var flag=storenameArr[j];
	                	dataindex=data.length;
	                	for(var k=0;k<data.length;k++){
	                		if(flag==data[k].name){
	                			str1+='<div class="oneBox">'+
	                			'<img src="'+data[k].url+'">'+
	                			'<span class="imgname">'+data[k].name+'</span>'+
	                			'<div class="imgstatus"></div>'+
	                			'<div class="shape"></div>'+
	                			'<div class="infoBox">'+
	                			'<div class="imginfo">'+
	                			'<div class="imgnm"></div>'+
	                			'<div class="img_status"></div>'+
	                			'<div class="imgmodify"></div>'+
	                			'</div>'+
	                			'<div class="comment">'+
	                			'<div class="commentTitle">描述信息：</div>'+
	                			'<textarea></textarea>'+
	                			'</div>'+
	                			/*'<div>是否标注<input type="checkbox"></div>'+'<div class="much">去标注</div>'+*/
	                			'<div class="paint">'+
	                			'<div class="switch">'+
	                			'<div class="ball"></div>'+
	                			'</div>'+
	                			'<button class="btn1">提交</button>'+
	                			'</div>'+
	                			'<div class="paint2">'+
	                			'<button class="btn2">注册</button>'+
	                			'<div class="gopaint">标注-></div>'+
	                			'</div>'+
	                			'</div>'+
	                			'</div>'	
	                			
	                		}
	                	}
	                	$(".right .imgBox").html(str1);
		                $(".right .oneBox").find("img").click(function(){
		                	var length=$(".oneBox").eq(0).offset().left;
		                	var current=$(this).parent().offset().left;
		                	$(this).parent().children(".shape,.infoBox").toggle();
		                	$(this).parent().siblings().children('.shape,.infoBox').hide();
		                	$(this).parent().css("margin-bottom",100).siblings().css("margin-bottom",5);
		                	$(this).parent().find(".infoBox").offset({left:length});
		                	var infoBoxArr=document.getElementsByClassName("infoBox");
		                	var oneBoxArr=document.getElementsByClassName("oneBox");
			               	for(var b=0;b<infoBoxArr.length;b++){
			               		if(infoBoxArr[b].style.display=="none"){
			               			oneBoxArr[b].style.marginBottom="5px";
			               		}
			               	}

		                });
		                function linkPaint(index){
		                	$(".right>.imgBox").find(".much").click(function(){
		                		if($(this).parent().find("input").prop("checked")){
		                			var flagtext=$(this).parent().parent().find("span").text();
		                			window.open('/lblorder-manip&proc-order:'+index+':'+flagtext);
		                		}
		                	});
	                	}
	                	linkPaint(index);
	                	/*$(".right>imgBox").find(".one").click(function(){
	                		var flagtext=$(this).parent().parent().find("span").text();
	                		//window.open('/show&'+flagtext);
	                	})*/
						//选框选中事件
						$(".infoBox input").change(function(){
							var flagText=$(this).parent().parent().parent().find("span").text();
							var userName=$(".userName").text();
							$(this).prop("disabled",true);
							$.ajax({
								url:'http://{{store_dict['remote_addr']}}:{{store_dict['port_number']}}/user-annot-status&append-img-status',
								data:{"order_idx":index,"user_name":userName,"img_name":flagText},
								type:'POST',
								dataType:'JSON',
								success:function(data){
									
								},
								error:function(err){
									console.log("1");
								}
							})
						})
	                	j++;

	                	judgeStatus(index);
	                	
	                }

            	})
			}
			//judgeStatus(index);
			
		}
		//页面跳转标注界面
		function goPaint(){
			
				var flagtext=$(this).parent().parent().parent().find("span").text();
	        	window.open('/show&'+flagtext);
	        	//window.open('/lblorder-manip&proc-order:'+index)
		}
		//提交信息函数
		function subInfo(){

		}
		
		//判断订单和图片的状态
		function judgeStatus(index){
			var userName=$(".userName").text();
			var imgstatus;
			$.ajax({
				url:'http://{{store_dict['remote_addr']}}:{{store_dict['port_number']}}/user-annot-status&check-order-status',
				data:{"order_idx":index,"user_name":userName},
				type:'POST',
				dataType:'JSON',
				success:function(data){
					console.log(data);
					//将图片信息数据添加到infoBox中
					//根据返回数据动态设置选框的状态
					/*$(".infoBox input").prop("checked",true);
					$(".infoBox input").prop("disabled",true);*/
					if(data.code==200){
						for(var i=0;i<data.status_list.length;i++){
							for(var j=0;j<$(".right .oneBox").find("span").length;j++){
								if(data.status_list[i].imgnm==$(".right .oneBox").find("span").eq(j).text()){
									//给图片添加状态样式
									if(data.status_list[i].status=="ongoing"){
										$(".oneBox").eq(j).find(".imgstatus").removeAttr("class").attr("class","ongoing imgstatus");
										$(".oneBox").eq(j).find(".img_status").text("标注状态：正在进行");
										$(".oneBox").eq(j).find(".switch").css("backgroundColor","green");
										$(".oneBox").eq(j).find(".ball").css("left","25px");
										$(".oneBox").eq(j).find(".btn2").css("color","gray");
										($(".oneBox").eq(j).find(".gopaint"))[0].onclick=goPaint;
										($(".oneBox").eq(j).find(".btn1"))[0].addEventListener("click",subInfo);
										
									}else{
										$(".oneBox").eq(j).find(".imgstatus").removeAttr("class").attr("class","finished imgstatus");
										$(".oneBox").eq(j).find(".img_status").text("标注状态：已完成");
										$(".oneBox").eq(j).find(".switch").css("backgroundColor","green");
										$(".oneBox").eq(j).find(".ball").css("left","25px");
										$(".oneBox").eq(j).find(".btn2").css("color","gray");
									}
								}
								else{
									if($(".oneBox").eq(j).find(".imgstatus").hasClass('ongoing')||$(".oneBox").eq(j).find(".imgstatus").hasClass('finished')){
											
									}else{
										$(".oneBox").eq(j).find(".imgstatus").removeAttr("class").attr("class","nodo imgstatus");
										$(".oneBox").eq(j).find(".img_status").text("标注状态：未标注");
										$(".oneBox").eq(j).find(".switch").css("backgroundColor","red");
										$(".oneBox").eq(j).find(".ball").css("left","0");
										$(".oneBox").eq(j).find("textarea").attr("disabled","disabled");
										($(".oneBox").eq(j).find(".btn1"))[0].removeEventListener("click",subInfo);
										($(".oneBox").eq(j).find(".btn2"))[0].onclick=function() {
											var parentOneBox=this.parentNode.parentNode.parentNode;
											var imgName=this.parentNode.parentNode.parentNode.getElementsByTagName("span")[0].innerText;
											console.log(index,userName,imgName);
											$.ajax({
												url:'http://{{store_dict['remote_addr']}}:{{store_dict['port_number']}}/user-annot-status&append-img-status',
												data:{"order_idx":index,"user_name":userName,"img_name":imgName},
												type:'POST',
												dataType:'JSON',
												success:function(data){
													console.log(data);
													//console.log(parentOneBox);
													//console.log($(".oneBox"));
													//console.log($(parentOneBox));
													$(parentOneBox).find(".switch").css("backgroundColor","green");
													$(parentOneBox).find(".ball").css("left","25px");
													$(parentOneBox).find("textarea").removeAttr("disabled");
													($(parentOneBox).find(".gopaint"))[0].onclick=goPaint;
													$(parentOneBox).find(".btn2").css("color","gray");
												},
												error:function(){
													console.log(1);
												}
											})
										};
									}
									
								};
							};
							//将图片信息数据添加到infoBox中
							/*$(".infoBox .imginfo").find(".imgnm").eq(i).text("图片名称："+data.status_list[i].imgnm);*/
							$(".infoBox .imginfo").find(".imgmodify").eq(i).text("更改时间："+data.status_list[i].last_modif_time);
								
						}
					}
					if(data.code==404){
						for(var k=0;k<$(".right .oneBox").find("span").length;k++){
							$(".oneBox").eq(k).find("div").eq(0).removeAttr("class").attr("class","nodo");
							$(".oneBox").eq(k).find("img_info").text("标注状态：未标注");
							$(".oneBox").eq(k).find(".switch").css("backgroundColor","red");
							$(".oneBox .paint").eq(k).find(".ball").css("left","0");
							($(".oneBox").eq(k).find(".btn2"))[0].onclick=function() {
								var parentOneBox=this.parentNode.parentNode.parentNode;
								var imgName=this.parentNode.parentNode.parentNode.getElementsByTagName("span")[0].innerText;
								console.log(index,userName,imgName);
								$.ajax({
									url:'http://{{store_dict['remote_addr']}}:{{store_dict['port_number']}}/user-annot-status&append-img-status',
									data:{"order_idx":index,"user_name":userName,"img_name":imgName},
									type:'POST',
									dataType:'JSON',
									success:function(data){
										console.log(data);
										//console.log(parentOneBox);
										//console.log($(".oneBox"));
										//console.log($(parentOneBox));
										$(parentOneBox).find(".switch").css("backgroundColor","green");
										$(parentOneBox).find(".ball").css("left","25px");
										$(parentOneBox).find("textarea").removeAttr("disabled");
										($(parentOneBox).find(".gopaint"))[0].onclick=goPaint;
										$(parentOneBox).find(".btn2").css("color","gray");
									},
									error:function(){
										console.log(1);
									}
								})
							};
						}
					}
					
				},
				error:function(){
					console.log("1")
				}
			})
		}
		function order_info(info){
			$(".orderInfo").show();
			var str="";
			str+=
			"<div>标注类型："+info.objtypes.substring(9)+"</div>"+
			"<div>创建时间："+info.start_time+"</div>"+
			"<div>标注用户："+info.users+"</div>"+
			"<div>描述信息："+info.description+"</div>";
			$(".orderInfo").html(str);
		}
		//时间下拉框变化
		$("#selTime").change(function(){
			var opt = $(this).find("option:selected");
			opt.attr("selected",true);	
			selOrder(userdataArr);
			$(".right ul").html("");
			$(".orderInfo").hide();
		});
		var info='<option value="all" selected="selected">全部</option>'+
				'<option value="3">过去3天</option>'+
				'<option value="7">过去7天</option>'+
				'<option value="30">过去30天</option>';
		
		$("#selTime").html(info);
		//根据时间显示数据函数
		function selOrder(dataArr){
			var value=document.getElementById("selTime").value;
			
			if(value=="all"){
				leftinfo(dataArr);
			}
			else{
				var nowTime=new Date();
				var ago,agoArr,month;
				var monthArr=["Jan","Feb","Mar","Apr","May","June","July","Aug","Sep","Otc","Nov","Dec"];
				var dayArr=[];
				for(var k=0;k<dataArr.length;k++){
					ago=dataArr[k].start_time;
					
					agoDate=ago.substring(5,25);
					agoArr=agoDate.split(" ");
					for(var l=0;l<monthArr.length;l++){
						if(agoArr[1]==monthArr[l]){
							month=(l+1);
							month=month<10?"0"+month:month;
							agoArr[1]=month.toString();
						}
					}
					var target = new Date(agoArr[2]+"/"+agoArr[1]+"/"+agoArr[0]);
					var timeSum = nowTime.getTime() - target.getTime();
					var differday = parseInt(timeSum/1000/60/60/24);
					//console.log(differday);
					if(differday<=value){
						dayArr.push(dataArr[k]);
					}

				}
				if(k==dataArr.length){
					leftinfo(dayArr);
				}
			}
		}

		function leftinfo(data){
			//判断是否存在数据
			if(data.length==0){

				$(".left>ul").html("<li class='empty'>暂无数据！</li>");
				return
			}
			var str="";
			for(var i=0;i<data.length;i++){
				str+='<li data-index='+data[i].id+'>';
				str+='<div>订单编号:'+data[i].id+'</div>'+
					 
					 '<div>描述信息:<br>'+data[i].description+'</div>'
				str+='</li>';
			}
			
			$(".left>ul").html(str);
			var colorFlag="";
			$(".left>ul>li").mouseenter(function(){
				color=$(this).css("backgroundColor");
				$(this).css({"backgroundColor":"rgba(0,0,255,.7)"});
			});
			$(".left>ul>li").mouseleave(function(){
				$(this).css({"backgroundColor":color});
			});
			$(".left>ul>li").click(function(){
				
				var index=$(this)[0].dataset['index'];
					$.ajax({
						url:'http://{{store_dict['remote_addr']}}:{{store_dict['port_number']}}/lblorder-manip&proc-order:'+index+':json',
						type:'POST',
						dataType:'JSON',
						success:function(info){

							imgInfo(info.storeinfos,index);
							order_info(info);
						},
						error:function(){

						}
					});
			});
		}
		//定义当前用户数据数组
		var userdataArr=[];
		//获取数据函数
		function show(){
			$.ajax({
				url:'http://{{store_dict['remote_addr']}}:{{store_dict['port_number']}}/lblorder-manip&get-orders',
				type:'POST',
				dataType:'JSON',
				success:function(data){
					var userName=$(".userName").text();
					
					//console.log(userName);
					for(var q=0;q<data.length;q++){
						var index=data[q].users.slice(6).indexOf(userName);
						if(index!==-1){
							userdataArr.push(data[q]);										
							//showOrder(dataArr);
						}
					}

						leftinfo(userdataArr);
					
					
					
				},
				error:function(err){
					console.log(err);
				}
			})
		}
		show();
		
	    //输出系统当前时间
	    function showTime(){
	    	var time=new Date();
	    	var year=time.getFullYear();
	    	var month=time.getMonth();
	    	var day=time.getDate();
	    	var week=time.getDay();
	    	var hour=time.getHours();
	    	var minutes=time.getMinutes();
	    	var seconds=time.getSeconds();
	    	var str="";
	    	str+="今天是:"+year+"年"+(month+1)+"月"+day+"日";
	    	$(".userBox span").eq(0).html(str);
	    }
	    showTime();
	    //退出登录
	    function logOut(){
	    	$(".userBox span").eq(3).css("cursor","pointer").click(function(){
	    		$.ajax({
	                url:'http://{{store_dict['remote_addr']}}:{{store_dict['port_number']}}/logout',
	                type:'GET',
	                success:function(data){
	                    window.location.href="http://{{store_dict['remote_addr']}}:{{store_dict['port_number']}}";
	                }
            	})
	    	});

	    }
	    logOut();
	</script>
</html>